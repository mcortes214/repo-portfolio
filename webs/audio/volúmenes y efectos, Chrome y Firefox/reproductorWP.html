<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Sound Window Player</title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
  <!-- Css Rangeslider -->
  <style media="screen">
  .rangeslider,
  .rangeslider__fill {
    display: block;
    -moz-box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.3);
    -webkit-box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.3);
    box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.3);
    -moz-border-radius: 10px;
    -webkit-border-radius: 10px;
    border-radius: 10px;
  }

  .rangeslider {
    background: #e6e6e6;
    position: relative;
  }

  .rangeslider--horizontal {
    height: 20px;
    width: 100%;
  }

  .rangeslider--vertical {
    width: 20px;
    min-height: 150px;
    max-height: 100%;
  }

  .rangeslider--disabled {
    filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=40);
    opacity: 0.4;
  }

  .rangeslider__fill {
    background: #00ff00;
    position: absolute;
  }
  .rangeslider--horizontal .rangeslider__fill {
    top: 0;
    height: 100%;
  }
  .rangeslider--vertical .rangeslider__fill {
    bottom: 0;
    width: 100%;
  }

  .rangeslider__handle {
    background: white;
    border: 1px solid #ccc;
    cursor: pointer;
    display: inline-block;
    width: 40px;
    height: 40px;
    position: absolute;
    background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjAuMCIgeDI9IjAuNSIgeTI9IjEuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIwLjAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMDAwMDAiIHN0b3Atb3BhY2l0eT0iMC4xIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmFkKSIgLz48L3N2Zz4g');
    background-size: 100%;
    background-image: -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, rgba(255, 255, 255, 0)), color-stop(100%, rgba(0, 0, 0, 0.1)));
    background-image: -moz-linear-gradient(rgba(255, 255, 255, 0), rgba(0, 0, 0, 0.1));
    background-image: -webkit-linear-gradient(rgba(255, 255, 255, 0), rgba(0, 0, 0, 0.1));
    background-image: linear-gradient(rgba(255, 255, 255, 0), rgba(0, 0, 0, 0.1));
    -moz-box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    -webkit-box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    -moz-border-radius: 50%;
    -webkit-border-radius: 50%;
    border-radius: 50%;
  }
  .rangeslider__handle:after {
    content: "";
    display: block;
    width: 18px;
    height: 18px;
    margin: auto;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjAuMCIgeDI9IjAuNSIgeTI9IjEuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwMDAwMCIgc3RvcC1vcGFjaXR5PSIwLjEzIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZmZmZmZmIiBzdG9wLW9wYWNpdHk9IjAuMCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==');
    background-size: 100%;
    background-image: -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, rgba(0, 0, 0, 0.13)), color-stop(100%, rgba(255, 255, 255, 0)));
    background-image: -moz-linear-gradient(rgba(0, 0, 0, 0.13), rgba(255, 255, 255, 0));
    background-image: -webkit-linear-gradient(rgba(0, 0, 0, 0.13), rgba(255, 255, 255, 0));
    background-image: linear-gradient(rgba(0, 0, 0, 0.13), rgba(255, 255, 255, 0));
    -moz-border-radius: 50%;
    -webkit-border-radius: 50%;
    border-radius: 50%;
  }
  .rangeslider__handle:active, .rangeslider--active .rangeslider__handle {
    background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjAuMCIgeDI9IjAuNSIgeTI9IjEuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwMDAwMCIgc3RvcC1vcGFjaXR5PSIwLjEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMDAwMDAiIHN0b3Atb3BhY2l0eT0iMC4xMiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==');
    background-size: 100%;
    background-image: -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, rgba(0, 0, 0, 0.1)), color-stop(100%, rgba(0, 0, 0, 0.12)));
    background-image: -moz-linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.12));
    background-image: -webkit-linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.12));
    background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.12));
  }
  .rangeslider--horizontal .rangeslider__handle {
    top: -10px;
    touch-action: pan-y;
    -ms-touch-action: pan-y;
  }
  .rangeslider--vertical .rangeslider__handle {
    left: -10px;
    touch-action: pan-x;
    -ms-touch-action: pan-x;
  }

  input[type="range"]:focus + .rangeslider .rangeslider__handle {
    -moz-box-shadow: 0 0 8px rgba(255, 0, 255, 0.9);
    -webkit-box-shadow: 0 0 8px rgba(255, 0, 255, 0.9);
    box-shadow: 0 0 8px rgba(255, 0, 255, 0.9);
  }

  </style>
  <!-- Estilos propios -->
  <style media="screen">
  body{
    font-family: sans-serif;
  }

  button.tape-controls-play {
      margin-top: 30px;
  }

  button.tape-controls-play {
      margin-top: 30px;
      background: transparent;
      border: 1px solid black;
      padding: 10px;
      cursor: pointer;
  }

  .elem-cancion-2{
    display: none;
  }

  .overlay-precarga {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 1;
      background-color: white;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
  }

  /* CONTENEDORES DE CANCIÓN */

  div.contenedor-cancion {
      display: none;
      width: 100%;
      flex-direction: column;
  }

  div.contenedor-cancion.activo{
    display: flex;
  }

  div.cancion{
    display: none;
  }

  div.cancion.activo{
    display: block;
  }

  div.contenedor-canales{
    display: flex;
    width: 100%;
    justify-content: space-around;
  }

  div.contenedor-canal {
    display: flex;
  }


  div.seek {
      margin-top: 30px;
      height: 60px;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }


  /* RANGE SLIDERS */

  .canales {
      display: flex;
      justify-content: space-around;
  }

  .canal {
    display: flex;
    align-items: center;
}

  /* Vertical */

  .rangeslider--vertical {
      width: 2px;
      background: #ddd;
      border-radius: 0;
      border: none;
      box-shadow: none;
  }

  .rangeslider--vertical .rangeslider__handle {
      width: 20px;
      height: 20px;
      left: -10px;
      box-shadow: none;
      background-color: black;
      border: 3px solid white;
  }

  .rangeslider--vertical .rangeslider__fill {
      bottom: 0;
      width: 100%;
      background-color: white;
      box-shadow: 0 0 0 1px black inset;
  }

  .rangeslider--vertical .rangeslider__handle {
      width: 10px;
      height: 10px;
      left: -4px;
      box-shadow: none;
      background-color: black;
      border: none;
  }

  .rangeslider--vertical .rangeslider__handle::after{
    display: none;
  }

  /* Controles de canal */

  /* Mute/solo */

  .contenedor-controles-canal {
      width: 20px;
      margin-left: 10px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
  }

  .boton-mute-canal,
  .boton-solo-canal{
    width: 20px;
    height: 20px;
    margin: 10px 0 0 0;
    border: 1px solid black;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .boton-mute-canal.activo,
  .boton-solo-canal.activo{
    background-color: #ddd;
  }


  /* Horizontal */

  .rangeslider--horizontal {
      height: 2px;
      background: #ddd;
      border-radius: 0;
      border: none;
      box-shadow: none;
  }

  .rangeslider--horizontal .rangeslider__handle {
      width: 20px;
      height: 20px;
      left: -10px;
      box-shadow: none;
      background-color: black;
      border: 3px solid white;
  }

  .rangeslider--horizontal .rangeslider__fill {
      bottom: 0;
      width: 100%;
      background-color: white;
      box-shadow: 0 0 0 1px black inset;
  }

  .rangeslider--horizontal .rangeslider__handle {
      width: 10px;
      height: 10px;
      top: -4px;
      box-shadow: none;
      background-color: black;
      border: none;
  }

  .rangeslider--horizontal .rangeslider__handle::after{
    display: none;
  }

  /* Seek */
  .seek{
    position: relative;
  }

  .visor-tiempo-seek{
    margin-bottom: 10px;
  }

  input.slider-seek-control + .rangeslider--horizontal {
      height: 8px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      cursor: pointer;
      opacity: 0;
      position: absolute;
      top: 0;
      z-index: 1;
  }

  input.slider-seek-view + .rangeslider--horizontal {
      height: 8px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      position: absolute;
      top: 0;
      z-index: 1;
  }

  input.slider-seek-view + .rangeslider--horizontal .rangeslider__handle{
    top: -3px;
    width: 14px;
    height: 14px;
  }

  input.slider-seek-view + .rangeslider--horizontal .rangeslider__fill{
    background-color: black;
  }

  /* INTERFACES GLOBALES */

  .contenedor-on-off{
    display: flex;
    justify-content: flex-start;
    align-items: center;
    margin: 20px 0 10px 0;
  }
  .contenedor-on-off span.global-control-tag {
    margin: 0;
  }

  .efecto-on-off {
    height: 15px;
    width: 15px;
    font-size: 0;
    border: 1px solid black;
    border-radius: 0;
    background: transparent;
    cursor: pointer;
    margin-left: 10px;
  }
  .efecto-on-off.activo{
    background-color: black;
  }

  .playback-control {
      cursor: pointer;
      font-size: 0;
      background: none;
      border: none;
      width: 20px;
      height: 20px;
      margin: 30px 5px;
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
  }

  #play-pause-button{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-play.png');
  }
  #play-pause-button.reproduciendo{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-pause.png');
  }
  #stop-button{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-stop.png');
  }
  #prev-button{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-prev.png');
  }
  #next-button{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-next.png');
  }
  #rwd-button{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-rwd.png');
    width: 40px;
  }
  #fwd-button{
    background-image: url('https://www.maxicortes.com.ar/webs/audio/img/boton-fwd.png');
    width: 40px;
  }



  span.global-control-tag {
      display: block;
      margin: 20px 0 10px 0;
  }

  button.boton-cancion {
      border: 1px solid black;
      background: none;
      padding: 10px 15px;
      margin: 10px 10px 30px 10px;
      cursor: pointer;
  }

  button.boton-cancion.activo {
    background-color: #f0f0f0;
  }

  /* ESTILOS DE DEBUG */



  </style>



  <!-- JS Rangeslider -->
  <script type="text/javascript">

  /*! rangeslider.js - v2.3.0 | (c) 2016 @andreruffert | MIT license | https://github.com/andreruffert/rangeslider.js */
  (function(factory) {
      'use strict';

      if (typeof define === 'function' && define.amd) {
          // AMD. Register as an anonymous module.
          define(['jquery'], factory);
      } else if (typeof exports === 'object') {
          // CommonJS
          module.exports = factory(require('jquery'));
      } else {
          // Browser globals
          factory(jQuery);
      }
  }(function($) {
      'use strict';

      // Polyfill Number.isNaN(value)
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isNaN
      Number.isNaN = Number.isNaN || function(value) {
          return typeof value === 'number' && value !== value;
      };

      /**
       * Range feature detection
       * @return {Boolean}
       */
      function supportsRange() {
          var input = document.createElement('input');
          input.setAttribute('type', 'range');
          return input.type !== 'text';
      }

      var pluginName = 'rangeslider',
          pluginIdentifier = 0,
          hasInputRangeSupport = supportsRange(),
          defaults = {
              polyfill: true,
              orientation: 'horizontal',
              rangeClass: 'rangeslider',
              disabledClass: 'rangeslider--disabled',
              activeClass: 'rangeslider--active',
              horizontalClass: 'rangeslider--horizontal',
              verticalClass: 'rangeslider--vertical',
              fillClass: 'rangeslider__fill',
              handleClass: 'rangeslider__handle',
              startEvent: ['mousedown', 'touchstart', 'pointerdown'],
              moveEvent: ['mousemove', 'touchmove', 'pointermove'],
              endEvent: ['mouseup', 'touchend', 'pointerup']
          },
          constants = {
              orientation: {
                  horizontal: {
                      dimension: 'width',
                      direction: 'left',
                      directionStyle: 'left',
                      coordinate: 'x'
                  },
                  vertical: {
                      dimension: 'height',
                      direction: 'top',
                      directionStyle: 'bottom',
                      coordinate: 'y'
                  }
              }
          };

      /**
       * Delays a function for the given number of milliseconds, and then calls
       * it with the arguments supplied.
       *
       * @param  {Function} fn   [description]
       * @param  {Number}   wait [description]
       * @return {Function}
       */
      function delay(fn, wait) {
          var args = Array.prototype.slice.call(arguments, 2);
          return setTimeout(function(){ return fn.apply(null, args); }, wait);
      }

      /**
       * Returns a debounced function that will make sure the given
       * function is not triggered too much.
       *
       * @param  {Function} fn Function to debounce.
       * @param  {Number}   debounceDuration OPTIONAL. The amount of time in milliseconds for which we will debounce the function. (defaults to 100ms)
       * @return {Function}
       */
      function debounce(fn, debounceDuration) {
          debounceDuration = debounceDuration || 100;
          return function() {
              if (!fn.debouncing) {
                  var args = Array.prototype.slice.apply(arguments);
                  fn.lastReturnVal = fn.apply(window, args);
                  fn.debouncing = true;
              }
              clearTimeout(fn.debounceTimeout);
              fn.debounceTimeout = setTimeout(function(){
                  fn.debouncing = false;
              }, debounceDuration);
              return fn.lastReturnVal;
          };
      }

      /**
       * Check if a `element` is visible in the DOM
       *
       * @param  {Element}  element
       * @return {Boolean}
       */
      function isHidden(element) {
          return (
              element && (
                  element.offsetWidth === 0 ||
                  element.offsetHeight === 0 ||
                  // Also Consider native `<details>` elements.
                  element.open === false
              )
          );
      }

      /**
       * Get hidden parentNodes of an `element`
       *
       * @param  {Element} element
       * @return {[type]}
       */
      function getHiddenParentNodes(element) {
          var parents = [],
              node    = element.parentNode;

          while (isHidden(node)) {
              parents.push(node);
              node = node.parentNode;
          }
          return parents;
      }

      /**
       * Returns dimensions for an element even if it is not visible in the DOM.
       *
       * @param  {Element} element
       * @param  {String}  key     (e.g. offsetWidth …)
       * @return {Number}
       */
      function getDimension(element, key) {
          var hiddenParentNodes       = getHiddenParentNodes(element),
              hiddenParentNodesLength = hiddenParentNodes.length,
              inlineStyle             = [],
              dimension               = element[key];

          // Used for native `<details>` elements
          function toggleOpenProperty(element) {
              if (typeof element.open !== 'undefined') {
                  element.open = (element.open) ? false : true;
              }
          }

          if (hiddenParentNodesLength) {
              for (var i = 0; i < hiddenParentNodesLength; i++) {

                  // Cache style attribute to restore it later.
                  inlineStyle[i] = hiddenParentNodes[i].style.cssText;

                  // visually hide
                  if (hiddenParentNodes[i].style.setProperty) {
                      hiddenParentNodes[i].style.setProperty('display', 'block', 'important');
                  } else {
                      hiddenParentNodes[i].style.cssText += ';display: block !important';
                  }
                  hiddenParentNodes[i].style.height = '0';
                  hiddenParentNodes[i].style.overflow = 'hidden';
                  hiddenParentNodes[i].style.visibility = 'hidden';
                  toggleOpenProperty(hiddenParentNodes[i]);
              }

              // Update dimension
              dimension = element[key];

              for (var j = 0; j < hiddenParentNodesLength; j++) {

                  // Restore the style attribute
                  hiddenParentNodes[j].style.cssText = inlineStyle[j];
                  toggleOpenProperty(hiddenParentNodes[j]);
              }
          }
          return dimension;
      }

      /**
       * Returns the parsed float or the default if it failed.
       *
       * @param  {String}  str
       * @param  {Number}  defaultValue
       * @return {Number}
       */
      function tryParseFloat(str, defaultValue) {
          var value = parseFloat(str);
          return Number.isNaN(value) ? defaultValue : value;
      }

      /**
       * Capitalize the first letter of string
       *
       * @param  {String} str
       * @return {String}
       */
      function ucfirst(str) {
          return str.charAt(0).toUpperCase() + str.substr(1);
      }

      /**
       * Plugin
       * @param {String} element
       * @param {Object} options
       */
      function Plugin(element, options) {
          this.$window            = $(window);
          this.$document          = $(document);
          this.$element           = $(element);
          this.options            = $.extend( {}, defaults, options );
          this.polyfill           = this.options.polyfill;
          this.orientation        = this.$element[0].getAttribute('data-orientation') || this.options.orientation;
          this.onInit             = this.options.onInit;
          this.onSlide            = this.options.onSlide;
          this.onSlideEnd         = this.options.onSlideEnd;
          this.DIMENSION          = constants.orientation[this.orientation].dimension;
          this.DIRECTION          = constants.orientation[this.orientation].direction;
          this.DIRECTION_STYLE    = constants.orientation[this.orientation].directionStyle;
          this.COORDINATE         = constants.orientation[this.orientation].coordinate;

          // Plugin should only be used as a polyfill
          if (this.polyfill) {
              // Input range support?
              if (hasInputRangeSupport) { return false; }
          }

          this.identifier = 'js-' + pluginName + '-' +(pluginIdentifier++);
          this.startEvent = this.options.startEvent.join('.' + this.identifier + ' ') + '.' + this.identifier;
          this.moveEvent  = this.options.moveEvent.join('.' + this.identifier + ' ') + '.' + this.identifier;
          this.endEvent   = this.options.endEvent.join('.' + this.identifier + ' ') + '.' + this.identifier;
          this.toFixed    = (this.step + '').replace('.', '').length - 1;
          this.$fill      = $('<div class="' + this.options.fillClass + '" />');
          this.$handle    = $('<div class="' + this.options.handleClass + '" />');
          this.$range     = $('<div class="' + this.options.rangeClass + ' ' + this.options[this.orientation + 'Class'] + '" id="' + this.identifier + '" />').insertAfter(this.$element).prepend(this.$fill, this.$handle);

          // visually hide the input
          this.$element.css({
              'position': 'absolute',
              'width': '1px',
              'height': '1px',
              'overflow': 'hidden',
              'opacity': '0'
          });

          // Store context
          this.handleDown = $.proxy(this.handleDown, this);
          this.handleMove = $.proxy(this.handleMove, this);
          this.handleEnd  = $.proxy(this.handleEnd, this);

          this.init();

          // Attach Events
          var _this = this;
          this.$window.on('resize.' + this.identifier, debounce(function() {
              // Simulate resizeEnd event.
              delay(function() { _this.update(false, false); }, 300);
          }, 20));

          this.$document.on(this.startEvent, '#' + this.identifier + ':not(.' + this.options.disabledClass + ')', this.handleDown);

          // Listen to programmatic value changes
          this.$element.on('change.' + this.identifier, function(e, data) {
              if (data && data.origin === _this.identifier) {
                  return;
              }

              var value = e.target.value,
                  pos = _this.getPositionFromValue(value);
              _this.setPosition(pos);
          });
      }

      Plugin.prototype.init = function() {
          this.update(true, false);

          if (this.onInit && typeof this.onInit === 'function') {
              this.onInit();
          }
      };

      Plugin.prototype.update = function(updateAttributes, triggerSlide) {
          updateAttributes = updateAttributes || false;

          if (updateAttributes) {
              this.min    = tryParseFloat(this.$element[0].getAttribute('min'), 0);
              this.max    = tryParseFloat(this.$element[0].getAttribute('max'), 100);
              this.value  = tryParseFloat(this.$element[0].value, Math.round(this.min + (this.max-this.min)/2));
              this.step   = tryParseFloat(this.$element[0].getAttribute('step'), 1);
          }

          this.handleDimension    = getDimension(this.$handle[0], 'offset' + ucfirst(this.DIMENSION));
          this.rangeDimension     = getDimension(this.$range[0], 'offset' + ucfirst(this.DIMENSION));
          this.maxHandlePos       = this.rangeDimension - this.handleDimension;
          this.grabPos            = this.handleDimension / 2;
          this.position           = this.getPositionFromValue(this.value);

          // Consider disabled state
          if (this.$element[0].disabled) {
              this.$range.addClass(this.options.disabledClass);
          } else {
              this.$range.removeClass(this.options.disabledClass);
          }

          this.setPosition(this.position, triggerSlide);
      };

      Plugin.prototype.handleDown = function(e) {
          e.preventDefault();
          this.$document.on(this.moveEvent, this.handleMove);
          this.$document.on(this.endEvent, this.handleEnd);

          // add active class because Firefox is ignoring
          // the handle:active pseudo selector because of `e.preventDefault();`
          this.$range.addClass(this.options.activeClass);

          // If we click on the handle don't set the new position
          if ((' ' + e.target.className + ' ').replace(/[\n\t]/g, ' ').indexOf(this.options.handleClass) > -1) {
              return;
          }

          var pos         = this.getRelativePosition(e),
              rangePos    = this.$range[0].getBoundingClientRect()[this.DIRECTION],
              handlePos   = this.getPositionFromNode(this.$handle[0]) - rangePos,
              setPos      = (this.orientation === 'vertical') ? (this.maxHandlePos - (pos - this.grabPos)) : (pos - this.grabPos);

          this.setPosition(setPos);

          if (pos >= handlePos && pos < handlePos + this.handleDimension) {
              this.grabPos = pos - handlePos;
          }
      };

      Plugin.prototype.handleMove = function(e) {
          e.preventDefault();
          var pos = this.getRelativePosition(e);
          var setPos = (this.orientation === 'vertical') ? (this.maxHandlePos - (pos - this.grabPos)) : (pos - this.grabPos);
          this.setPosition(setPos);
      };

      Plugin.prototype.handleEnd = function(e) {
          e.preventDefault();
          this.$document.off(this.moveEvent, this.handleMove);
          this.$document.off(this.endEvent, this.handleEnd);

          this.$range.removeClass(this.options.activeClass);

          // Ok we're done fire the change event
          this.$element.trigger('change', { origin: this.identifier });

          if (this.onSlideEnd && typeof this.onSlideEnd === 'function') {
              this.onSlideEnd(this.position, this.value);
          }
      };

      Plugin.prototype.cap = function(pos, min, max) {
          if (pos < min) { return min; }
          if (pos > max) { return max; }
          return pos;
      };

      Plugin.prototype.setPosition = function(pos, triggerSlide) {
          var value, newPos;

          if (triggerSlide === undefined) {
              triggerSlide = true;
          }

          // Snapping steps
          value = this.getValueFromPosition(this.cap(pos, 0, this.maxHandlePos));
          newPos = this.getPositionFromValue(value);

          // Update ui
          this.$fill[0].style[this.DIMENSION] = (newPos + this.grabPos) + 'px';
          this.$handle[0].style[this.DIRECTION_STYLE] = newPos + 'px';
          this.setValue(value);

          // Update globals
          this.position = newPos;
          this.value = value;

          if (triggerSlide && this.onSlide && typeof this.onSlide === 'function') {
              this.onSlide(newPos, value);
          }
      };

      // Returns element position relative to the parent
      Plugin.prototype.getPositionFromNode = function(node) {
          var i = 0;
          while (node !== null) {
              i += node.offsetLeft;
              node = node.offsetParent;
          }
          return i;
      };

      Plugin.prototype.getRelativePosition = function(e) {
          // Get the offset DIRECTION relative to the viewport
          var ucCoordinate = ucfirst(this.COORDINATE),
              rangePos = this.$range[0].getBoundingClientRect()[this.DIRECTION],
              pageCoordinate = 0;

          if (typeof e.originalEvent['client' + ucCoordinate] !== 'undefined') {
              pageCoordinate = e.originalEvent['client' + ucCoordinate];
          }
          else if (
            e.originalEvent.touches &&
            e.originalEvent.touches[0] &&
            typeof e.originalEvent.touches[0]['client' + ucCoordinate] !== 'undefined'
          ) {
              pageCoordinate = e.originalEvent.touches[0]['client' + ucCoordinate];
          }
          else if(e.currentPoint && typeof e.currentPoint[this.COORDINATE] !== 'undefined') {
              pageCoordinate = e.currentPoint[this.COORDINATE];
          }

          return pageCoordinate - rangePos;
      };

      Plugin.prototype.getPositionFromValue = function(value) {
          var percentage, pos;
          percentage = (value - this.min)/(this.max - this.min);
          pos = (!Number.isNaN(percentage)) ? percentage * this.maxHandlePos : 0;
          return pos;
      };

      Plugin.prototype.getValueFromPosition = function(pos) {
          var percentage, value;
          percentage = ((pos) / (this.maxHandlePos || 1));
          value = this.step * Math.round(percentage * (this.max - this.min) / this.step) + this.min;
          return Number((value).toFixed(this.toFixed));
      };

      Plugin.prototype.setValue = function(value) {
          if (value === this.value && this.$element[0].value !== '') {
              return;
          }

          // Set the new value and fire the `input` event
          this.$element
              .val(value)
              .trigger('input', { origin: this.identifier });
      };

      Plugin.prototype.destroy = function() {
          this.$document.off('.' + this.identifier);
          this.$window.off('.' + this.identifier);

          this.$element
              .off('.' + this.identifier)
              .removeAttr('style')
              .removeData('plugin_' + pluginName);

          // Remove the generated markup
          if (this.$range && this.$range.length) {
              this.$range[0].parentNode.removeChild(this.$range[0]);
          }
      };

      // A really lightweight plugin wrapper around the constructor,
      // preventing against multiple instantiations
      $.fn[pluginName] = function(options) {
          var args = Array.prototype.slice.call(arguments, 1);

          return this.each(function() {
              var $this = $(this),
                  data  = $this.data('plugin_' + pluginName);

              // Create a new instance.
              if (!data) {
                  $this.data('plugin_' + pluginName, (data = new Plugin(this, options)));
              }

              // Make it possible to access methods from public.
              // e.g `$element.rangeslider('method');`
              if (typeof options === 'string') {
                  data[options].apply(data, args);
              }
          });
      };

      return 'rangeslider.js is available in jQuery context e.g $(selector).rangeslider(options);';

  }));


  </script>
</head>
<body>

<!-- HTML Reproductor -->
<div id="reproductor">

  <div class="overlay-precarga">
    <p>Loading audio files...</p>
    <progress id="progress" value="0" max="100"></progress>
    <p class="indicador-progreso">0%</p>
  </div>


  <div id="selectores-canciones"></div>   <!-- Contenido dinámico -->
  <div id="canciones"></div>                <!-- Contenido dinámico -->
  <div id="controles-globales">




    <span class="global-control-tag">Master</span>
    <input type="range" class="rangeslider" data-accion="volumen-master" id="volumen-master" min="0" max="1" value="0.5" step="0.001" data-orientation="horizontal">


    <div class="contenedor-on-off">
      <span class="global-control-tag">Delay on/off:</span>
      <button type="button" id="delay-on-off" class="efecto-on-off"></button>
    </div>
    <span class="global-control-tag">Delay time</span>
    <input type="range" class="rangeslider" data-accion="delay-time" id="delay-time" min="0" max="1" value="0" step="0.001" data-orientation="horizontal">
    <span class="global-control-tag">Delay feedback</span>
    <input type="range" class="rangeslider" data-accion="delay-feedback" id="delay-feedback" min="0" max="1" value="0" step="0.001" data-orientation="horizontal">

    <div class="contenedor-on-off">
      <span class="global-control-tag">Reverb on/off:</span>
      <button type="button" id="reverb-on-off" class="efecto-on-off"></button>
    </div>
    <span class="global-control-tag">Reverb level</span>
    <input type="range" class="rangeslider" data-accion="reverb-wet" id="reverb-wet" min="0" max="4" value="0" step="0.001" data-orientation="horizontal">


<!-- Descomentar playback! -->

    <!-- Playback -->
    <button class="playback-control" id="prev-button">PREV</button>
    <button class="playback-control" id="rwd-button">RWD</button>
    <button class="playback-control" id="play-pause-button">Play/pause</button>
    <button class="playback-control" id="stop-button">Stop</button>
    <button class="playback-control" id="fwd-button">FWD</button>
    <button class="playback-control" id="next-button">NEXT</button>

  </div><!-- fin controles globales -->
  <div id="audios">

  </div>
</div><!-- fin reproductor -->





<!-- SCRIPTS -->

<script type="text/javascript">

console.log('Sound Window Player v3.0:');


// Sintaxis:

// ESTO ES UNA SECCIÓN ----------------------
// Puede contener cuatro subsecciones:
// Funciones
// Variables
// Event binding
// Ejecución

// Separadores:

// function func1() {
//   código;
// }

// //-----

// function func2() {
//   código;
// }

// DEJAR UNAS 10 LÍNEAS ENTRE SECCIÓN Y SECCIÓN


//
// Convenciones:
//
// - camelCase
// - Las variables que son flags, comienzan en "es" (ej: esPrimeraCancion)
// - Dentro de loops, usar la palabra "esta" (ej: esteTrack) para referirse
// al índice actual
// - Un contenedor tiene nombre plural; un item, nombre singular
// - Todo elemento único del DOM tiene ID, no clase
// - Un elemento de interfaz se indica en su ID ("slider-", "boton-", etc.)
// Mientras que elementos contenedores tienen nombres genéricos como "canal"





// VARIABLES GLOBALES ----------------------



//Estructuras de datos, parseo de iframe
var songInfo = {};
var cantidadDeCanciones = 0;

var audioTags = {};
var audioURLs = {};
var nodes = {};

var impulseSource;

//Elementos del DOM
const elementoSelectores = document.getElementById('selectores-canciones');
const elementoCanciones = document.getElementById('canciones');




// GESTIÓN DE MENSAJES -----------------------------------


// Funciones

function receiveMessage(e){
  if(event.data=='mouseup'){
    $(document).mouseup();        //Soltar el mouse al salir del iframe
    console.log('mouseup');
  }
  return new Promise(function(resolve, reject){
    if(event.data!='mouseup'){
      console.log('mensaje recibido');
      parsearMensaje(event.data);
      resolve();
    }
  });
}



//-----

function parsearMensaje(datos){

  var songs = datos.tracks;
  var rv = datos.reverb;
  impulseSource = rv;

  for(var i=0; i < Object.keys(songs).length; i++){
    var key = Object.keys(songs)[i];
    var tracks = Object.keys(songs[key]);
    var tracksQtt = tracks.length;

    //Llenar objeto songInfo
    songInfo[i] = {
      name: key,
      length: tracksQtt,
    };

    //Llenar objeto audioURLs
    audioURLs[i] = {};                          //Crear objeto canción
    for (var j = 0; j < tracksQtt; j++) {
      var trackKey = tracks[j];                 //Key original recibida
      audioURLs[i][j] = songs[key][trackKey];
    }

    //Incrementar cantidadDeCanciones
    cantidadDeCanciones++;
  }
}





//-----





// WEB AUDIO API  -----------------------------------

var AudioContext = window.AudioContext // Default
    || window.webkitAudioContext // Safari and old versions of Chrome
    || false;

if (AudioContext) {
    // Do whatever you want using the Web Audio API
    var audioCtx = new AudioContext;
    // ...
} else {
    // Web Audio API is not supported
    // Alert the user
    alert("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox");
}

// GENERACIÓN DE DOM -----------------------------------

//Variables

var esPrimeraCancion = true;

// Funciones

function generarDOM() {
  console.log('generarDOM ejecutándose');
   return new Promise(function(resolve, reject){

     //para cada canción
     for (var i = 0; i < cantidadDeCanciones; i++) {

       //en los elementos globales...

       var nombreEstaCancion = songInfo[i].name;
       generarSelector(i, nombreEstaCancion);      //generar cada selector
       generarCancionIndividual(i);            //generar cada canción,
                                               //con su estructura de seek

       // Y para cada track dentro de la canción seleccionada,
       var tracksEnEstaCancion = songInfo[i].length;
       var elementoCanalesEstaCancion = document.getElementById('canales-cancion-'+i);

       for (var j = 0; j < tracksEnEstaCancion; j++) {
         // - Generar un channel strip ("#canal")
         generarCanalIndividual(elementoCanalesEstaCancion, i, j);
       }

       //E inicializar todos los sliders
       inicializarRangeslider();

       //Cambiar flag para las siguientes canciones
       esPrimeraCancion = false;
     }
     resolve();
   });
}

//-----

function inicializarRangeslider() {
  $('input[type="range"]').rangeslider({
    polyfill: false,
    onSlide: function(){
      moverControl(this.$element[0]);   //target del evento
      //moverControl es una función de Interfaz. Ir a esa sección para verla
    }
  });
}

//-----

function generarCanalIndividual(elementoCanalesEstaCancion, i, j){
  console.log(audioURLs);
  //Por default los audios tienen la URL online. Pero si se deja cargar los audios,
  //el src se reemplaza por el del blob.
  $(elementoCanalesEstaCancion).append(`
    <div class="canal">
      <input type="range" class="rangeslider" data-accion="volumen-canal" data-cancion="`+i+`" data-track="`+j+`" id="volumen-cancion-`+i+`-track-`+j+`" min="0" max="1" value="0.5" step="0.001" data-orientation="vertical">
      <div class="contenedor-controles-canal">
        <div class="boton-mute-canal" data-cancion="`+i+`" data-track="`+j+`" id="mute-cancion-`+i+`-track-`+j+`">M</div>
      </div>
      <audio id="audio-cancion-`+i+`-track-`+j+`" src="`+audioURLs[i][j]+`" crossorigin="anonymous"></audio>
    </div>
    `);
}

//-----

function generarCancionIndividual(i) {

  if(esPrimeraCancion){
    $(elementoCanciones).append(`
      <div class="cancion activo" data-cancion="`+i+`" id="cancion-`+i+`">
        <div class="canales" data-cancion="`+i+`" id="canales-cancion-`+i+`"></div>
        <div class="seek" data-cancion="`+i+`" id="seek-cancion-`+i+`">
          <input type="range" class="rangeslider slider-seek-view" data-accion="seek-view" data-cancion="`+i+`" id="slider-seek-view-cancion-`+i+`" min="0" max="2" value="0" step="0.001" data-orientation="horizontal">
          <input type="range" class="rangeslider slider-seek-control" data-accion="seek-control" data-cancion="`+i+`" id="slider-seek-control-cancion-`+i+`" min="0" max="2" value="0" step="0.001" data-orientation="horizontal">
          <div class="seek-clock" id="seek-clock-cancion-`+i+`">
            <span class="seek-minutos">00</span>:<span class="seek-segundos">00</span>
          </div>
        </div>
      </div>
      `);
  }
  else {
    $(elementoCanciones).append(`
      <div class="cancion" data-cancion="`+i+`" id="cancion-`+i+`">
        <div class="canales" data-cancion="`+i+`" id="canales-cancion-`+i+`"></div>
        <div class="seek" data-cancion="`+i+`" id="seek-cancion-`+i+`">
          <input type="range" class="rangeslider slider-seek-view" data-accion="seek-view" data-cancion="`+i+`" id="slider-seek-view-cancion-`+i+`" min="0" max="2" value="0" step="0.001" data-orientation="horizontal">
          <input type="range" class="rangeslider slider-seek-control" data-accion="seek-control" data-cancion="`+i+`" id="slider-seek-control-cancion-`+i+`" min="0" max="2" value="0" step="0.001" data-orientation="horizontal">
          <div class="seek-clock" id="seek-clock-cancion-`+i+`">
            <span class="seek-minutos">00</span>:<span class="seek-segundos">00</span>
          </div>
        </div>
      </div>
      `);
  }
}


//-----

function generarSelector(i, nombreCancion) {
  if(esPrimeraCancion){
    $(elementoSelectores).append(
      '<button type="button" class="boton-cancion activo" data-cancion="'+i+'">'+nombreCancion+'</button>'
    );
  }
  else{
    $(elementoSelectores).append(
      '<button type="button" class="boton-cancion" data-cancion="'+i+'">'+nombreCancion+'</button>'
    );
  }
}





//DESCARGA E IMPLEMENTACIÓN DE AUDIOS
//Bajar los audios por HTTP, gestionar precarga, crear tags <audio>

//ACÁ TAMBIÉN BAJAR LA REVERB

// Variables

var listaSolicitudes = {};
var contadorSolicitudes = 0;
var intervaloPrecarga;
const progressBar = document.getElementById('progress');
var contadorAudiosDescargados = 0;
const elementoAudios = document.getElementById('audios');
var reverbBlob;

// Funciones

function descargarAudios() {
   return new Promise(function(resolve, reject){

     //loopear por todas las URLS de audios, y
     // Declarar solicitudes HTTP en array propio
      for (var i = 0; i < cantidadDeCanciones; i++) {
        var tracksEnEstaCancion = songInfo[i].length;
        for (var j = 0; j < tracksEnEstaCancion; j++) {
          var url = audioURLs[i][j];
          var req = new XMLHttpRequest();
          listaSolicitudes[contadorSolicitudes] = {
            'url': url,
            'req': req,
            'song': i,
            'track': j
          };
          contadorSolicitudes++;
        }
      }

      //Configurar, abrir y enviar las solicitudes usando el nuevo array
      for (var i = 0; i < contadorSolicitudes; i++) {
        var url = listaSolicitudes[i].url;
        var req = listaSolicitudes[i].req;

        req.open('GET', url, true);
        req.responseType = 'blob';
        req.onprogress = onProgress;
        req.onload = onLoad;
        req.send();
      }
      //Enviar las solicitudes una vez que están todas listas, no antes

      //Solicitud de reverb
      console.log('Cargando reverb...');
      var reqRv = new XMLHttpRequest();
      reqRv.open('GET', impulseSource, true);
      reqRv.responseType = 'arraybuffer';
      reqRv.onload = onLoadReverb;
      reqRv.send();

      // Iniciar intervalo de precarga
      intervaloPrecarga = setInterval(actualizarPrecarga, 500);
   });
}




//------

function actualizarPrecarga(){
  console.log('tick');
  var sumaDePorcentajes = 0;
  var cantidadDeSolicitudes = Object.keys(listaSolicitudes).length;
  for (var i = 0; i < cantidadDeSolicitudes; i++) {
    sumaDePorcentajes += listaSolicitudes[i].cargado;
  }

  porcentajeCargadoTotal = sumaDePorcentajes/cantidadDeSolicitudes;
  try{
    progressBar.value = Math.trunc(porcentajeCargadoTotal);
    $('.indicador-progreso').html(porcentajeCargadoTotal.toFixed(2) + '%');
  }
  catch(e){
    //no hacer nada todavía
  }
}

//------

function onProgress(e) {
  //Actualizar la propiedad "cargado" de cada solicitud
  if (e.lengthComputable) {
    var url = e.currentTarget.responseURL;
    //Ver cuál de las solicitudes fue la que progresó
    for (var k = 0; k < contadorSolicitudes; k++) {
      if(listaSolicitudes[k].url == url){
        listaSolicitudes[k].cargado = e.loaded/e.total*100;
      }
    }
  }
}

//------

function onLoad(e) {
  if (this.status === 200) {
     var url = e.currentTarget.responseURL;
     var audioBlob = this.response;
     var blobURL = URL.createObjectURL(audioBlob); // IE10+
     console.log('audio cargado');
     //Ver cuál de las solicitudes fue la que se cargó
     for (var k = 0; k < contadorSolicitudes; k++) {
       if(listaSolicitudes[k].url == url){
         cancionDeEstaSolicitud = listaSolicitudes[k].song;
         trackDeEstaSolicitud = listaSolicitudes[k].track;
         console.log(cancionDeEstaSolicitud);
         console.log(trackDeEstaSolicitud);
         audioTag = document.getElementById('audio-cancion-'+cancionDeEstaSolicitud+'-track-'+trackDeEstaSolicitud);
         audioTag.src = blobURL;
       }
     }
     contadorAudiosDescargados++;

     if(contadorAudiosDescargados == contadorSolicitudes){
       postAudioLoad();      //Función principal. Listada en Ejecución
     }
   }
}

//------

function onLoadReverb(e) {
  if (this.status === 200) {
    var url = e.currentTarget.responseURL;
    reverbBlob = this.response;

      console.log('Reverb descargada');
   }
}

//------






// FUNCIONALIDAD DE INTERFAZ - acá vincular controles con variables

// Variables

const botonPlayPause = document.getElementById('play-pause-button');
const botonDetener = document.getElementById('stop-button');
const botonPrev = document.getElementById('prev-button');
const botonNext = document.getElementById('next-button');
const botonRwd = document.getElementById('rwd-button');
const botonFwd = document.getElementById('fwd-button');

var cancionActiva = 0;

// Funciones

//Mover control captura los eventos de todos los sliders.
function moverControl(input) {
  var valor = input.value;
  var accion = $(input).data('accion');


  //Seek ----
  if(accion=="seek-control"){
    //obtener ID de cancion
    var cancion = $(input).data('cancion');
    saltarA(cancion, parseInt(input.value));
  }


  //Volumen canales ----
  if(accion=="volumen-canal"){
    //obtener ID de cancion
    console.log('vol');
    var cancion = $(input).data('cancion');
    var track = $(input).data('track');
    nodes[cancion][track].gain.gain.value = input.value;
  }


  //Volumen master ----
  if(accion=="volumen-master"){
    //obtener ID de cancion
    var cancion = cancionActiva;
    nodes.masterGain.gain.value = input.value;
  }

  //Delay ----
  if(accion=='delay-time'){
    nodes.delay.delayTime.value = input.value;
  }

  if(accion=='delay-feedback'){
    nodes.delayFeedback.gain.value = input.value;
  }

  //Reverb ----
  if(accion=='reverb-wet'){
    nodes.reverbGain.gain.value = input.value;
  }

}

//Mapear interfaces: event listeners para todos los botones
function mapearInterfaces() {

  //Selectores de canción

  $(document).on('click', '.boton-cancion', function () {
    //Detener reproducción
    detener(cancionActiva);
    //Reconocer canción clickeada
    var dataCancion = $(this).attr('data-cancion');
    var selectorSeccionCancion = '.cancion[data-cancion="'+ dataCancion +'"]';
    var cancionSeleccionada = $(selectorSeccionCancion);
    //Cambiar clases
    $('.boton-cancion').removeClass('activo'); //eliminar el activo de todos los contenedores
    $(this).addClass('activo'); //agregarla a la canción seleccionada
    $('.cancion').removeClass('activo'); //eliminar el activo de todos los contenedores
    cancionSeleccionada.addClass('activo'); //agregarla a la canción seleccionada
    cancionActiva = dataCancion;
    console.log(cancionActiva);
    //Modificar routeo de nodos (master)
    nodes[cancionActiva].bus.connect(nodes.masterGain);
  });

  //Canción previa

  $(botonPrev).on('click', function () {
    //Detener reproducción
    detener(cancionActiva);
    //Reconocer canción previa
    var dataCancion;
    if (cancionActiva!=0) { //si no es la primera
      dataCancion = cancionActiva - 1;
      console.log('cancion previa');
    }
    else{  //si es la primera (igual a 0)
      dataCancion = 0;  //mantenerlo en 0
      console.log('era primera cancion');
    }
    var selectorSeccionCancion = '.cancion[data-cancion="'+ dataCancion +'"]';
    var cancionSeleccionada = $(selectorSeccionCancion);
    //Cambiar clases
    $('.boton-cancion').removeClass('activo'); //eliminar el activo de todos los contenedores
    $('.boton-cancion[data-cancion="'+ dataCancion +'"]').addClass('activo'); //agregarla a la canción seleccionada

    $('.cancion').removeClass('activo'); //eliminar el activo de todos los contenedores
    cancionSeleccionada.addClass('activo'); //agregarla a la canción seleccionada
    cancionActiva = dataCancion;
    console.log(cancionActiva);
    //Modificar routeo de nodos (master)
    nodes[cancionActiva].bus.connect(nodes.masterGain);
  });

  //Canción siguiente

  $(botonNext).on('click', function () {
    //Detener reproducción
    detener(cancionActiva);
    //Reconocer canción previa
    var dataCancion;
    if (cancionActiva!=cantidadDeCanciones-1) { //si no es la última
      dataCancion = cancionActiva + 1;
      console.log('cancion siguiente');
    }
    else{  //si es la primera (igual a 0)
      dataCancion = cantidadDeCanciones-1;  //mantenerlo en su valor actual
      console.log('era última cancion');
    }
    var selectorSeccionCancion = '.cancion[data-cancion="'+ dataCancion +'"]';
    var cancionSeleccionada = $(selectorSeccionCancion);
    //Cambiar clases
    $('.boton-cancion').removeClass('activo'); //eliminar el activo de todos los contenedores
    $('.boton-cancion[data-cancion="'+ dataCancion +'"]').addClass('activo'); //agregarla a la canción seleccionada

    $('.cancion').removeClass('activo'); //eliminar el activo de todos los contenedores
    cancionSeleccionada.addClass('activo'); //agregarla a la canción seleccionada
    cancionActiva = dataCancion;
    console.log(cancionActiva);
    //Modificar routeo de nodos (master)
    nodes[cancionActiva].bus.connect(nodes.masterGain);
  });

  //Rewind

  $(botonRwd).on('click', function () {
    //Obtener tiempo actual
    var primerTrackActivo = document.getElementById('audio-cancion-'+cancionActiva+'-track-0');
    currTime = primerTrackActivo.currentTime;
    console.log('CURRENTTIME: '+currTime);
    //Solo si pasaron más de 10 segundos desde el inicio de la canción:
    if (currTime > 10) {
      // Saltar
      saltarA(cancionActiva, currTime-10);
    }
  });

  //Fast forward

  $(botonFwd).on('click', function () {
    //Obtener tiempo actual
    var primerTrackActivo = document.getElementById('audio-cancion-'+cancionActiva+'-track-0');
    currTime = primerTrackActivo.currentTime;
    currDuration = primerTrackActivo.duration;
    console.log('CURRENTTIME: '+currTime);
    console.log('CURRDURATION: '+currDuration);

    //Solo si faltan menos de 10 segundos para terminar la canción:
    if (currDuration-currTime > 10) {
      // Saltar
      saltarA(cancionActiva, currTime+10);
    }
  });

  //Play/pause

  $(botonPlayPause).on('click', function () {
    $(this).toggleClass('reproduciendo');
    if($(this).hasClass('reproduciendo')){
      reproducir(cancionActiva);
    }
    else{
      pausar(cancionActiva);
    }
  });

  //Stop

  $(botonDetener).on('click', function () {
      detener(cancionActiva);
  });


  //Mute
  $('.boton-mute-canal').on('click', function () {
      var cancion = $(this).data('cancion');
      var track = $(this).data('track');
      var nodoMute = nodes[cancion][track].mute;
      $(this).toggleClass('activo');
      if ($(this).hasClass('activo')) {
        nodoMute.gain.value = 0;
      }
      else {
        nodoMute.gain.value = 1;
      }
  });


  //Delay on/off
  $('#delay-on-off').on('click', function () {
    $(this).toggleClass('activo');

    if($(this).hasClass('activo')){ //si se activó
      nodes.delay.connect(audioCtx.destination);
    }
    else{
      nodes.delay.disconnect(audioCtx.destination);
    }
  });


  //Reverb on/off
  $('#reverb-on-off').on('click', function () {
    $(this).toggleClass('activo');

    if($(this).hasClass('activo')){ //si se activó
      nodes.reverbGain.connect(audioCtx.destination);
    }
    else{
      nodes.reverbGain.disconnect(audioCtx.destination);
    }
  });

}




// AUDIO NODES - Creación y routeo --------------------------------------------



function crearAudioNodes() {
    console.log('empezando a crear audio nodes');

    //Actualizar el objeto global "nodes", guardando los nodos en estructura de
    // árbol

    //nodos globales (se declaran ahora, que ya se inicializó el audio context)
    nodes['masterGain'] = audioCtx.createGain();

    nodes['reverb'] = audioCtx.createConvolver();
    nodes['reverbGain'] = audioCtx.createGain();
    nodes.reverbGain.gain.value = 0;
    nodes['reverbSource'] = audioCtx.createBufferSource();

    nodes['delay'] = audioCtx.createDelay();
    nodes.delay.delayTime.value = 0;
    nodes['delayFeedback'] = audioCtx.createGain();
    nodes.delayFeedback.gain.value = 0;

    //Cargar audio de la reverb dentro del nodo correspondiente
    console.log(reverbBlob);
    audioCtx.decodeAudioData(reverbBlob, function(buffer) {
        nodes['reverbSource'].buffer = buffer;
        nodes['reverb'].buffer = nodes['reverbSource'].buffer;
        console.log('buffered reverb');
      });


    for (var i = 0; i < cantidadDeCanciones; i++) {
      //nodos de canción
      nodes[i] = {
        'bus' : audioCtx.createGain()
      };
      var tracksEnEstaCancion = songInfo[i].length;

      for (var j = 0; j < tracksEnEstaCancion; j++) {
        //obtener elemento media
        var mediaElement = document.getElementById('audio-cancion-'+i+'-track-'+j);
        //nodos de track
        nodes[i][j] = {
          'source' : audioCtx.createMediaElementSource(mediaElement),
          'gain' : audioCtx.createGain(),
          'mute' : audioCtx.createGain(),
        }
      }
    }

}

/**/

function routearAudioNodes() {
  console.log('routeando audio nodes');

  for (var i = 0; i < cantidadDeCanciones; i++) {
    var tracksEnEstaCancion = songInfo[i].length;
    for (var j = 0; j < tracksEnEstaCancion; j++) {
      nodes[i][j].source.connect(nodes[i][j].gain);
      nodes[i][j].gain.connect(nodes[i][j].mute);
      nodes[i][j].mute.connect(nodes[i].bus);
    }
  }

  nodes[0].bus.connect(nodes.masterGain);  //primera canción por default

  nodes.masterGain.connect(audioCtx.destination); //sonido directo

  nodes.masterGain.connect(nodes.reverb);
  nodes.reverb.connect(nodes.reverbGain);
  // nodes.reverbGain.connect(audioCtx.destination); //sonido reverberado en paralelo
  //Reverb desconectada por default. Conectar con on/off

  nodes.masterGain.connect(nodes.delay);
  nodes.delay.connect(nodes.delayFeedback);
  nodes.delayFeedback.connect(nodes.delay);
  // nodes.delay.connect(audioCtx.destination); //Sonido con feedback
  //Delay desconectado por default. Conectar con on/off


}












// PLAYBACK --------------------------------------------

var intervaloSeek;
var intervaloTestMetadata;


//Funciones de reproducción de audio (controlan al seek)

function reproducir(cancion){
  if (audioCtx.state === 'suspended') {
    console.log('audio suspendido');
    audioCtx.resume();
    console.log('reanudando audio');
  }

  var tracksEnEstaCancion = songInfo[cancion].length;

  for(var i=0; i < tracksEnEstaCancion; i++){
    var audio = document.getElementById('audio-cancion-'+cancion+'-track-'+i);
    audio.play();
    setInterval(function(){
      console.log(audio.paused);
    },2000);
  }
  reproducirSeek(cancion);
}

//------

function pausar(cancion){
  var tracksEnEstaCancion = songInfo[cancion].length;

  for(var i=0; i < tracksEnEstaCancion; i++){
    var audio = document.getElementById('audio-cancion-'+cancion+'-track-'+i);
    audio.pause();
  }
  pausarSeek(cancion);
}

//------

function detener(cancion){
  var tracksEnEstaCancion = songInfo[cancion].length;

  for(var i=0; i < tracksEnEstaCancion; i++){
    var audio = document.getElementById('audio-cancion-'+cancion+'-track-'+i);
    audio.pause();
    audio.currentTime = 0;

    //si el botón estaba reproduciendo, ponerlo en no reproduciendo
    if($('#play-pause-button').hasClass('reproduciendo')){
      $('#play-pause-button').toggleClass('reproduciendo');
    }
  }
  pausarSeek(cancion);
}

//------

function saltarA(cancion, segundos){
  var tracksEnEstaCancion = songInfo[cancion].length;
  // Para cada audio de la canción,
  for(var i=0; i<tracksEnEstaCancion; i++){
    var track = document.getElementById('audio-cancion-'+cancion+'-track-'+i);
    track.currentTime = segundos;
    actualizarVisorSeek(cancion);
  }
}

//Funciones de preparación y reproducción de seek (controladas por audio)


//------

function reproducirSeek(cancion){
  var primerAudioEnEstaCancion = document.getElementById('audio-cancion-'+cancion+'-track-0');
  var tiempoTranscurrido;
  intervaloSeek = setInterval(function(){
    // Obtener currentTime del primer audio de la canción
    tiempoTranscurrido = primerAudioEnEstaCancion.currentTime;
    console.log(tiempoTranscurrido);
    actualizarVisorSeek(cancion);
  },100);
}

//------

function pausarSeek(cancion) {
  var primerAudioEnEstaCancion = document.getElementById('audio-cancion-'+cancion+'-track-0');
  var tiempoTranscurrido = primerAudioEnEstaCancion.currentTime;
  clearInterval(intervaloSeek);
  actualizarVisorSeek(cancion);
}

//------

function inicializarSeeks() {
  intervaloTestMetadata = setInterval(function(){
    //En cada intento:
    var contadorSeeksListos = 0;  //reiniciar el contador.

    //Para cada canción,
    for (var i = 0; i < cantidadDeCanciones; i++) {
      console.log('chequeando metadata canción '+i+'...');
      var audio = document.getElementById('audio-cancion-'+i+'-track-0');
      if (audio.readyState > 0) {    //si hay metadata
        cambiarValoresMaximosSeek(audio, i);
        contadorSeeksListos++;
      }
      else{
        console.log('canción '+i+' aún no lista.');
      }
    }
    if(contadorSeeksListos==cantidadDeCanciones){
      clearInterval(intervaloTestMetadata);
    }
    //Cuando todos los audios tengan su evento, terminar el ciclo
  },1000);
}

//------

function cambiarValoresMaximosSeek(aud, indice){
  duracionTotal = aud.duration;
  //Actualizar valor máximo de los input
  var objetoInput = $('#slider-seek-control-cancion-'+indice);
  var objetoMarcador = $('#slider-seek-view-cancion-'+indice);

  objetoInput.attr('max', aud.duration);
  objetoMarcador.attr('max', aud.duration);
  objetoInput.rangeslider('update', true);
  objetoMarcador.rangeslider('update', true);
}

//------

function actualizarVisorSeek(cancion){

  var primerAudioEnEstaCancion = document.getElementById('audio-cancion-'+cancion+'-track-0');
  var tiempoTranscurrido = primerAudioEnEstaCancion.currentTime;


  var seekView = document.getElementById('slider-seek-view-cancion-'+cancion);
  $(seekView).val(tiempoTranscurrido).change();
  $(seekView).rangeslider('update', true);


  var segundosParaVisor = Math.trunc(tiempoTranscurrido) % 60;
  var minutosParaVisor = Math.trunc(tiempoTranscurrido/60);

  // segundos
  if(segundosParaVisor<10){
    $('#seek-clock-cancion-'+cancion+' .seek-segundos').html('0'+segundosParaVisor);
    if(segundosParaVisor==0){
      $('#seek-clock-cancion-'+cancion+' .seek-segundos').html('00');
    }
  }
  else{
    $('#seek-clock-cancion-'+cancion+' .seek-segundos').html(segundosParaVisor);
  }

  // minutos
  if(minutosParaVisor<10){
    $('#seek-clock-cancion-'+cancion+' .seek-minutos').html('0'+minutosParaVisor);
    if(minutosParaVisor==0){
      $('#seek-clock-cancion-'+cancion+' .seek-minutos').html('00');
    }
  }
  else{
    $('#seek-clock-cancion-'+cancion+' .seek-minutos').html(minutosParaVisor);
  }
}


//ANIMACIÓN ---------------------------------------------

function borrarOverlay() {
  $('.overlay-precarga').animate({'opacity':'0'},1000,function(){
    $('.overlay-precarga').css({'display':'none'});
  });
}




// DEBUG --------------------------------------------














// EJECUCIÓN --------------------------------------------




// Modelo de promise:

// function someAsynFunction() {
//    return new Promise(function(resolve, reject){
//         // código
//    });
// }

//Promise chaining:

// loadScript("/article/promise-chaining/one.js")
//   .then(script => loadScript("/article/promise-chaining/two.js"))
//   .then(script => loadScript("/article/promise-chaining/three.js"))




// Funciones



// Función main: incluye todas las promises en orden. Llama a todo el código
//Todo el código se dispara desde el evento que recibe el mensaje.
//Así como en otros proyectos, todo el código se dispara en el evento
// document.ready.

function main(e) {
  receiveMessage(e).then(generarDOM).then(descargarAudios); //CON DESCARGA
  // receiveMessage(e).then(generarDOM).then(postAudioLoad); //TESTEO PLAYBACK
}




//Función postAudioLoad: Esta función es llamada desde el callback onload de
// los XHR, al completarse el último audio. Se lista acá porque es una función
// principal que lista todas las acciones después de la descarga.

function postAudioLoad() {
  console.log('todos los audios cargados');
  clearInterval(intervaloPrecarga);
  crearAudioNodes();
  routearAudioNodes();
  mapearInterfaces();
  inicializarSeeks();
  borrarOverlay();
}




//Llamar todo el código desde el event listener:
window.addEventListener("message", main, false);

</script>



</body>
</html>
